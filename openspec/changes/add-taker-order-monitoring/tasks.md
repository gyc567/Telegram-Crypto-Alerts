# 任务清单：4.3.4 吃单监控实现

## 📋 任务概览

**项目**: 吃单监控 (Taker Order Monitoring)
**变更编号**: CHANGE-2025-0105
**创建日期**: 2025-11-09
**预计工期**: 9-11 天
**优先级**: 高

---

## 🎯 核心目标

实现吃单监控功能，包括：
- BTC 单笔订单 ≥ 50 告警
- ETH 单笔订单 ≥ 2000 告警
- 1分钟内吃单累积 ≥ $1M USD + ≥5笔告警
- 实时 WebSocket 数据处理
- 与现有大额订单监控并行运行

---

## 📦 任务分解

### 阶段1: 核心架构设计 (3-4天)

#### 任务 1.1: 创建 TakerOrderTracker 类
- [ ] **文件**: `src/monitor/taker_orders/src/tracker.py`
- [ ] **内容**:
  - [ ] TakerOrderTracker 抽象基类
  - [ ] 单笔订单阈值配置 (BTC: 50, ETH: 2000)
  - [ ] 累积监控配置 ($1M USD, ≥5笔, 1分钟窗口)
  - [ ] 订单状态管理
  - [ ] 回调函数设置
- [ ] **验收**:
  - [ ] 正确初始化阈值配置
  - [ ] 状态管理正常工作
  - [ ] 回调函数正确调用

#### 任务 1.2: 实现 OrderTypeClassifier
- [ ] **文件**: `src/monitor/taker_orders/src/classifier.py`
- [ ] **内容**:
  - [ ] 吃单/挂单分类算法
  - [ ] 深度变化分析逻辑
  - [ ] 实时分类方法
  - [ ] 分类准确率验证
- [ ] **验收**:
  - [ ] 准确分类吃单 vs 挂单
  - [ ] 延迟 < 100ms
  - [ ] 准确率 > 95%

#### 任务 1.3: 集成到监控框架
- [ ] **文件**: `src/monitor/taker_orders/core/`
- [ ] **内容**:
  - [ ] TakerOrderMonitor 核心类
  - [ ] 与现有 LargeOrderMonitor 并行
  - [ ] 统一事件总线集成
  - [ ] 生命周期管理
- [ ] **验收**:
  - [ ] 双监控并行运行无冲突
  - [ ] 内存使用 < 200MB
  - [ ] CPU 使用率 < 5%

#### 任务 1.4: 单元测试
- [ ] **文件**: `tests/test_taker_order_monitor/test_tracker.py`
- [ ] **内容**:
  - [ ] TakerOrderTracker 测试
  - [ ] OrderTypeClassifier 测试
  - [ ] 阈值检测测试
  - [ ] 累积聚合测试
- [ ] **验收**:
  - [ ] 测试覆盖 > 90%
  - [ ] 所有测试通过
  - [ ] TDD 流程合规

---

### 阶段2: 数据流处理 (2-3天)

#### 任务 2.1: WebSocket 数据过滤
- [ ] **文件**: `src/monitor/taker_orders/exchanges/binance.py`
- [ ] **内容**:
  - [ ] 扩展现有 WebSocket 客户端
  - [ ] Trade Stream 订阅
  - [ ] 吃单数据过滤
  - [ ] 数据预处理
- [ ] **验收**:
  - [ ] 实时数据获取
  - [ ] 过滤准确率 = 100%
  - [ ] 延迟 < 200ms

#### 任务 2.2: 单笔订单阈值检测
- [ ] **文件**: `src/monitor/taker_orders/core/single_monitor.py`
- [ ] **内容**:
  - [ ] BTC ≥ 50 检测
  - [ ] ETH ≥ 2000 检测
  - [ ] 买卖方向区分
  - [ ] 立即告警触发
- [ ] **验收**:
  - [ ] BTC 阈值检测准确
  - [ ] ETH 阈值检测准确
  - [ ] 方向判断正确
  - [ ] 告警延迟 < 300ms

#### 任务 2.3: 1分钟滚动窗口
- [ ] **文件**: `src/monitor/taker_orders/core/window.py`
- [ ] **内容**:
  - [ ] 滚动窗口实现
  - [ ] 时间窗口管理
  - [ ] 窗口数据清理
  - [ ] 窗口聚合算法
- [ ] **验收**:
  - [ ] 窗口大小 = 60秒
  - [ ] 数据聚合正确
  - [ ] 内存无泄漏
  - [ ] 性能稳定

#### 任务 2.4: 累积聚合算法
- [ ] **文件**: `src/monitor/taker_orders/core/cumulative.py`
- [ ] **内容**:
  - [ ] 同方向订单聚合
  - [ ] $1M USD 阈值检测
  - [ ] ≥5笔订单验证
  - [ ] 总金额和平均金额计算
- [ ] **验收**:
  - [ ] 聚合逻辑正确
  - [ ] 阈值检测准确
  - [ ] 计算结果精确
  - [ ] 性能达标

---

### 阶段3: 告警系统 (2天)

#### 任务 3.1: 告警消息格式化
- [ ] **文件**: `src/monitor/taker_orders/core/formatter.py`
- [ ] **内容**:
  - [ ] 消息模板设计
  - [ ] 时间范围格式化
  - [ ] 方向标识（买入/卖出）
  - [ ] 订单数、金额格式化
  - [ ] 表情符号和样式
- [ ] **格式示例**:
  ```
  [吃单监控] BTC/USDT
  时间范围: 14:35:00-14:36:00 (60秒)
  方向: 主动买入
  订单数: 7笔
  总金额: $1,250,000
  平均金额: $178,571
  ```
- [ ] **验收**:
  - [ ] 消息格式规范
  - [ ] 信息完整准确
  - [ ] 可读性良好

#### 任务 3.2: 冷却机制
- [ ] **文件**: `src/monitor/taker_orders/core/cooldown.py`
- [ ] **内容**:
  - [ ] 5分钟冷却时间
  - [ ] 每交易对独立冷却
  - [ ] 冷却状态管理
  - [ ] 冷却恢复机制
- [ ] **验收**:
  - [ ] 冷却时间 = 300秒
  - [ ] 无重复告警
  - [ ] 冷却状态正确

#### 任务 3.3: Telegram 集成
- [ ] **文件**: `src/telegram.py` (更新)
- [ ] **内容**:
  - [ ] 新增 4 个命令
  - [ ] 命令处理器实现
  - [ ] 权限验证（白名单/管理员）
  - [ ] 响应消息生成
- [ ] **命令列表**:
  - [ ] `/taker_status` - 查看吃单监控状态
  - [ ] `/taker_symbols` - 查看监控的交易对
  - [ ] `/taker_alerts` - 查看吃单告警历史（管理员）
  - [ ] `/taker_config` - 查看吃单监控配置（管理员）
- [ ] **验收**:
  - [ ] 所有命令正常工作
  - [ ] 权限控制正确
  - [ ] 响应准确及时

#### 任务 3.4: 告警发送
- [ ] **文件**: `src/alert_processes/taker_order.py`
- [ ] **内容**:
  - [ ] TakerOrderAlertProcess 类
  - [ ] 告警队列管理
  - [ ] 消息发送逻辑
  - [ ] 发送状态跟踪
- [ ] **验收**:
  - [ ] 告警发送成功率 = 100%
  - [ ] 延迟 < 500ms
  - [ ] 无消息丢失

---

### 阶段4: 测试与优化 (2天)

#### 任务 4.1: 集成测试
- [ ] **文件**: `tests/test_taker_order_monitor/test_integration.py`
- [ ] **内容**:
  - [ ] 端到端测试
  - [ ] WebSocket 集成测试
  - [ ] 告警链路测试
  - [ ] 并发处理测试
- [ ] **验收**:
  - [ ] 所有测试通过
  - [ ] 无内存泄漏
  - [ ] 并发稳定

#### 任务 4.2: 性能测试
- [ ] **文件**: `tests/test_taker_order_monitor/test_performance.py`
- [ ] **内容**:
  - [ ] 延迟测试
  - [ ] 吞吐量测试
  - [ ] 资源使用测试
  - [ ] 压力测试
- [ ] **指标**:
  - [ ] 数据处理延迟 < 200ms
  - [ ] 告警生成延迟 < 500ms
  - [ ] CPU 使用率 < 5%
  - [ ] 内存使用 < 200MB
  - [ ] 吞吐量 > 1000 trades/秒

#### 任务 4.3: 误报率优化
- [ ] **文件**: `src/monitor/taker_orders/core/filter.py`
- [ ] **内容**:
  - [ ] 异常交易过滤
  - [ ] 重复交易去重
  - [ ] 误报分析算法
  - [ ] 动态阈值调整
- [ ] **验收**:
  - [ ] 误报率 < 3%
  - [ ] 漏报率 < 1%
  - [ ] 过滤准确率 > 97%

#### 任务 4.4: 文档更新
- [ ] **文件**: `src/resources/help_command.txt` (更新)
- [ ] **文件**: `src/resources/commands.txt` (更新)
- [ ] **文件**: `src/monitor/taker_orders/README.md`
- [ ] **内容**:
  - [ ] 新增命令说明
  - [ ] 功能使用指南
  - [ ] 配置参数说明
  - [ ] 故障排除指南
- [ ] **验收**:
  - [ ] 文档完整准确
  - [ ] 示例代码有效
  - [ ] 用户友好

---

## 📊 里程碑

| 里程碑 | 日期 | 交付物 | 验收标准 |
|--------|------|--------|----------|
| M1: 架构完成 | 第4天 | 核心类 + 单元测试 | 单元测试 > 90% |
| M2: 数据流完成 | 第7天 | WebSocket + 聚合 | 性能测试达标 |
| M3: 告警完成 | 第9天 | 告警系统 | 端到端测试通过 |
| M4: 发布完成 | 第11天 | 完整功能 | 所有验收标准通过 |

---

## 🔧 技术栈

- **语言**: Python 3.8+
- **框架**: asyncio, websockets
- **测试**: pytest, pytest-asyncio, pytest-cov
- **数据库**: 文件存储 (JSON)
- **消息队列**: 内置队列
- **监控**: 日志 + 统计

---

## 📝 任务依赖

```
任务 1.1 (tracker)
    ↓
任务 1.2 (classifier) ←→ 任务 1.3 (集成)
    ↓                      ↓
任务 2.1 (WebSocket) ←→ 任务 2.2 (单笔检测)
    ↓                      ↓
任务 2.3 (滚动窗口) ←→ 任务 2.4 (累积聚合)
    ↓                      ↓
任务 3.1 (格式化) ←→ 任务 3.2 (冷却)
    ↓                      ↓
任务 3.3 (Telegram) ←→ 任务 3.4 (发送)
    ↓
任务 4.1 (集成测试)
    ↓
任务 4.2 (性能测试)
    ↓
任务 4.3 (误报优化)
    ↓
任务 4.4 (文档)
```

---

## 🚨 风险与缓解

| 任务 | 风险 | 缓解措施 |
|------|------|---------|
| 1.1-1.3 | 架构设计复杂 | 迭代设计，代码评审 |
| 2.1 | WebSocket 性能 | 异步架构，连接池 |
| 2.2-2.4 | 聚合算法复杂 | 简化逻辑，性能测试 |
| 3.1-3.4 | 告警误报 | 阈值优化，过滤器 |
| 4.1-4.2 | 性能不达标 | 代码优化，架构调整 |

---

## ✅ 验收清单

### 代码质量
- [ ] 代码风格符合项目规范 (black, flake8)
- [ ] 文档字符串完整 (Google 风格)
- [ ] 类型注解完整
- [ ] 单元测试覆盖 > 90%
- [ ] 集成测试覆盖核心流程

### 功能性
- [ ] BTC 单笔订单 ≥ 50 触发告警
- [ ] ETH 单笔订单 ≥ 2000 触发告警
- [ ] 1分钟累积 ≥ $1M USD + ≥5笔触发告警
- [ ] 买卖方向正确识别
- [ ] 冷却机制生效（5分钟）

### 性能
- [ ] 数据处理延迟 < 200ms
- [ ] 告警生成延迟 < 500ms
- [ ] CPU 使用率 < 5%
- [ ] 内存使用 < 200MB
- [ ] 吞吐量 > 1000 trades/秒

### 稳定性
- [ ] 连续运行 24 小时无崩溃
- [ ] 异常情况优雅处理
- [ ] 告警送达率 = 100%
- [ ] 无内存泄漏
- [ ] WebSocket 连接稳定

### 用户体验
- [ ] 命令响应及时
- [ ] 告警消息清晰
- [ ] 错误提示友好
- [ ] 文档完整易读

---

*任务清单基于 OpenSpec 规范生成*
