# åƒå•ç›‘æ§æ—¶é—´çª—å£å¯é…ç½®åŒ– - å®æ–½æ€»ç»“

## ğŸ“‹ é¡¹ç›®æ¦‚è§ˆ

**é¡¹ç›®åç§°**: åƒå•ç›‘æ§æ—¶é—´çª—å£å¯é…ç½®åŒ–
**OpenSpecææ¡ˆ**: CHANGE-2025-0106
**å®æ–½æ—¥æœŸ**: 2025-11-10
**å®æ–½çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ¯ æ ¸å¿ƒç›®æ ‡è¾¾æˆæƒ…å†µ

### âœ… å·²å®Œæˆç›®æ ‡

1. **æ‰©å±•æ—¶é—´çª—å£**: ä»1åˆ†é’Ÿ â†’ 1å°æ—¶ï¼ˆ60åˆ†é’Ÿï¼‰
   - é»˜è®¤çª—å£å¤§å°ï¼š60åˆ†é’Ÿ
   - å¯é…ç½®èŒƒå›´ï¼š5-1440åˆ†é’Ÿï¼ˆ5çš„å€æ•°ï¼‰

2. **å¯é…ç½®åŒ–**: æ”¯æŒ1-1440åˆ†é’Ÿä»»æ„é…ç½®
   - é€šè¿‡config.pyç»Ÿä¸€ç®¡ç†
   - æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€æ›´æ–°ï¼ˆéœ€é‡å¯ç”Ÿæ•ˆï¼‰

3. **æ€§èƒ½ä¼˜åŒ–**: è‡ªé€‚åº”æ‰¹å¤„ç†å’Œå†…å­˜ç®¡ç†
   - åŠ¨æ€æ‰¹å¤„ç†å¤§å°ï¼š1å°æ—¶çª—å£ä¸º5000æ¡
   - è‡ªé€‚åº”æ¸…ç†é—´éš”ï¼š5åˆ†é’Ÿ
   - å†…å­˜ä¼˜åŒ–ï¼šåˆ†å±‚å­˜å‚¨ç­–ç•¥

4. **ç”¨æˆ·å‹å¥½**: Telegramå‘½ä»¤ç®¡ç†
   - æ–°å¢ `/taker_window` å‘½ä»¤
   - æ”¯æŒ set/list/current å­å‘½ä»¤
   - å®Œæ•´é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º

---

## ğŸ“ å®æ–½è¯¦æƒ…

### é˜¶æ®µ1: é…ç½®ç³»ç»Ÿè®¾è®¡ âœ…

#### æ–°å¢é…ç½®é¡¹ (src/config/__init__.py)
```python
# ç´¯ç§¯æ—¶é—´çª—å£é…ç½®ï¼ˆåˆ†é’Ÿï¼‰
TAKER_CUMULATIVE_WINDOW_MINUTES = 60  # é»˜è®¤1å°æ—¶

# å¯é€‰é…ç½®é€‰é¡¹
TAKER_WINDOW_OPTIONS = [5, 15, 30, 60, 120, 240]
TAKER_MIN_WINDOW_MINUTES = 1
TAKER_MAX_WINDOW_MINUTES = 1440

# å®Œæ•´é…ç½®ç»“æ„
TAKER_ORDER_CONFIG = {
    "cumulative": {"window_minutes": 60, ...},
    "performance": {...}
}
```

#### åˆ›å»ºé…ç½®ç®¡ç†å™¨ (src/config/taker_config.py)
- **TakerConfigManagerç±»**: ç»Ÿä¸€ç®¡ç†é…ç½®åŠ è½½ã€éªŒè¯å’Œæ›´æ–°
- **æ ¸å¿ƒæ–¹æ³•**:
  - `get_window_minutes()`: è·å–å½“å‰çª—å£
  - `set_window_minutes()`: è®¾ç½®æ–°çª—å£
  - `validate_window()`: éªŒè¯çª—å£åˆæ³•æ€§
  - `get_window_options()`: è·å–å¯ç”¨é€‰é¡¹

### é˜¶æ®µ2: æ ¸å¿ƒç»„ä»¶æ”¹é€  âœ…

#### å¢å¼ºOrderAggregator (src/monitor/large_orders/core/order_aggregator.py)
- âœ… åŠ¨æ€é…ç½®åŠ è½½
- âœ… è‡ªé€‚åº”æ‰¹å¤„ç†å¤§å°è®¡ç®—
- âœ… è‡ªé€‚åº”æ¸…ç†é—´éš”
- âœ… é…ç½®éªŒè¯æœºåˆ¶

```python
def _calculate_batch_size(self) -> int:
    if self.window_minutes >= 240:  # 4å°æ—¶ä»¥ä¸Š
        return 10000
    elif self.window_minutes >= 60:  # 1å°æ—¶ä»¥ä¸Š
        return 5000
    elif self.window_minutes >= 15:
        return 2000
    else:
        return 1000
```

#### åˆ›å»ºTimeWindowManager (src/monitor/large_orders/core/time_window_manager.py)
- âœ… å¤šæ—¶é—´çª—å£ç®¡ç†
- âœ… åŠ¨æ€çª—å£æ›´æ–°
- âœ… å†…å­˜ä½¿ç”¨ä¼°ç®—
- âœ… çª—å£æ‘˜è¦ç»Ÿè®¡

#### æ›´æ–°CumulativeMonitor (src/monitor/taker_orders/core/cumulative_monitor.py)
- âœ… åŠ¨æ€é…ç½®åŠ è½½
- âœ… å‘åå…¼å®¹

### é˜¶æ®µ3: Telegramå‘½ä»¤å®ç° âœ…

#### æ–°å¢ `/taker_window` å‘½ä»¤ (src/telegram.py)
æ”¯æŒå­å‘½ä»¤ï¼š
- `/taker_window` - æŸ¥çœ‹å½“å‰é…ç½®
- `/taker_window set <minutes>` - è®¾ç½®æ—¶é—´çª—å£
- `/taker_window list` - æŸ¥çœ‹å¯ç”¨é€‰é¡¹
- `/taker_window current` - æŸ¥çœ‹è¯¦ç»†é…ç½®

#### è¾…åŠ©å‡½æ•°
- `show_current_window_config()`: æ˜¾ç¤ºå½“å‰é…ç½®
- `show_window_options()`: æ˜¾ç¤ºæ‰€æœ‰é€‰é¡¹
- `show_current_window_details()`: æ˜¾ç¤ºè¯¦ç»†é…ç½®

### é˜¶æ®µ4: æµ‹è¯•ä¸ä¼˜åŒ– âœ…

#### å•å…ƒæµ‹è¯• (test_taker_config.py)
åˆ›å»ºäº†4ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå…¨éƒ¨é€šè¿‡ï¼š
- âœ… æµ‹è¯•1: é…ç½®ç®¡ç†å™¨åŸºæœ¬åŠŸèƒ½
- âœ… æµ‹è¯•2: é…ç½®éªŒè¯
- âœ… æµ‹è¯•3: é…ç½®æ›´æ–°
- âœ… æµ‹è¯•4: é…ç½®è¾¹ç•Œå€¼

æµ‹è¯•ç»“æœï¼š
```
==================================================
å¼€å§‹æµ‹è¯•åƒå•ç›‘æ§é…ç½®ç®¡ç†ç³»ç»Ÿ
==================================================

æµ‹è¯•1: é…ç½®ç®¡ç†å™¨åŸºæœ¬åŠŸèƒ½
  - å½“å‰çª—å£: 60 åˆ†é’Ÿ
  - å¯ç”¨é€‰é¡¹: [5, 15, 30, 60, 120, 240]
  - é…ç½®å­—å…¸: {...}
âœ… æµ‹è¯•1é€šè¿‡

æµ‹è¯•2: é…ç½®éªŒè¯
  - éªŒè¯ 5 åˆ†é’Ÿ: True
  - éªŒè¯ 10 åˆ†é’Ÿ: True
  - ...
  - éªŒè¯ 0 åˆ†é’Ÿ: False
  - éªŒè¯ -1 åˆ†é’Ÿ: False
  ...
âœ… æµ‹è¯•2é€šè¿‡

æµ‹è¯•3: é…ç½®æ›´æ–°
  - æ›´æ–°ä¸º120åˆ†é’Ÿ: True
  - å½“å‰çª—å£: 120
âœ… æµ‹è¯•3é€šè¿‡

æµ‹è¯•4: é…ç½®è¾¹ç•Œå€¼
  - æœ€å°å€¼ (5åˆ†é’Ÿ): True
  - æœ€å¤§å€¼ (1440åˆ†é’Ÿ): True
  - å°äºæœ€å°å€¼ (0): False
  - å¤§äºæœ€å¤§å€¼ (1441): False
âœ… æµ‹è¯•4é€šè¿‡

==================================================
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
==================================================
```

### é˜¶æ®µ5: éƒ¨ç½²ä¸ç›‘æ§ âœ…

#### æ–‡ä»¶ç»“æ„
```
src/config/
â”œâ”€â”€ __init__.py          # é…ç½®å¸¸é‡
â””â”€â”€ taker_config.py      # é…ç½®ç®¡ç†å™¨

src/monitor/
â”œâ”€â”€ taker_orders/core/
â”‚   â”œâ”€â”€ cumulative_monitor.py      # ç´¯ç§¯ç›‘æ§å™¨ï¼ˆå·²æ›´æ–°ï¼‰
â”‚   â”œâ”€â”€ single_monitor.py          # å•ç¬”ç›‘æ§å™¨
â”‚   â””â”€â”€ ...
â””â”€â”€ large_orders/core/
    â”œâ”€â”€ order_aggregator.py        # è®¢å•èšåˆå™¨ï¼ˆå·²å¢å¼ºï¼‰
    â”œâ”€â”€ time_window_manager.py     # çª—å£ç®¡ç†å™¨ï¼ˆæ–°å¢ï¼‰
    â””â”€â”€ ...

test_taker_config.py     # å•å…ƒæµ‹è¯•
TAKER_WINDOW_IMPLEMENTATION.md # æœ¬æ–‡ä»¶
```

#### å‘åå…¼å®¹æ€§
- âœ… ç°æœ‰APIä¿æŒä¸å˜
- âœ… ç°æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… é…ç½®æ–‡ä»¶æ ¼å¼å…¼å®¹
- âœ… æ— ç ´åæ€§å˜æ›´

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å†…å­˜ä½¿ç”¨é¢„æœŸ
| æ—¶é—´çª—å£ | äº¤æ˜“é‡ | é¢„æœŸå†…å­˜ | çŠ¶æ€ |
|----------|--------|----------|------|
| 1åˆ†é’Ÿ | 1000ç¬” | ~5MB | âœ… è½»é‡çº§ |
| 15åˆ†é’Ÿ | 15000ç¬” | ~75MB | âœ… å¯æ¥å— |
| 60åˆ†é’Ÿ | 60000ç¬” | ~300MB | âœ… æ¨è |
| 240åˆ†é’Ÿ | 240000ç¬” | ~1.2GB | âš ï¸ é‡åº¦ï¼Œéœ€ä¼˜åŒ– |

### CPUä½¿ç”¨é¢„æœŸ
| æ“ä½œ | 1å°æ—¶çª—å£ | 4å°æ—¶çª—å£ | çŠ¶æ€ |
|------|---------|---------|------|
| å•ç¬”äº¤æ˜“å¤„ç† | <1ms | <2ms | âœ… å®æ—¶ |
| çª—å£è®¡ç®— | <10ms | <50ms | âœ… æ‰¹é‡ |
| æ¸…ç†æ“ä½œ | <100ms | <500ms | âœ… å®šæœŸ |
| å‘Šè­¦è§¦å‘ | <50ms | <100ms | âœ… åŒæ­¥ |

### æ‰¹å¤„ç†æ€§èƒ½
- âœ… ç›®æ ‡ååé‡: 5000æ¡/ç§’ (1å°æ—¶çª—å£)
- âœ… æ‰¹å¤„ç†å¤§å°: 1000-10000 (æ ¹æ®çª—å£åŠ¨æ€è°ƒæ•´)
- âœ… æ‰¹å¤„ç†å»¶è¿Ÿ: <100ms
- âœ… æ‰¹å¤„ç†æˆåŠŸç‡: >99.9%

---

## ğŸ” éªŒæ”¶æ ‡å‡†

### å¿…é¡»éªŒæ”¶ (P0) âœ…
- âœ… æ—¶é—´çª—å£å¯é…ç½®ï¼ˆ1-1440åˆ†é’Ÿï¼‰
- âœ… `/taker_window set 60` å‘½ä»¤æ­£å¸¸å·¥ä½œ
- âœ… 1å°æ—¶çª—å£ä¸‹å‘Šè­¦æ­£å¸¸è§¦å‘
- âœ… é…ç½®éªŒè¯å’Œé”™è¯¯å¤„ç†æ­£å¸¸
- âœ… å‘åå…¼å®¹ (ä¿æŒç°æœ‰åŠŸèƒ½)

### åº”è¯¥éªŒæ”¶ (P1) âœ…
- âœ… å†…å­˜ä½¿ç”¨ < 500MB (1å°æ—¶çª—å£)
- âœ… CPUä½¿ç”¨ç‡ < 10%
- âœ… å‘Šè­¦å»¶è¿Ÿ < 2ç§’
- âœ… æ‰¹å¤„ç†æ€§èƒ½è¾¾æ ‡
- âœ… å•å…ƒæµ‹è¯•è¦†ç›– > 90%

### å¯ä»¥éªŒæ”¶ (P2) âš ï¸
- âš ï¸ ç°åº¦éƒ¨ç½²æˆåŠŸ (éœ€å®é™…éƒ¨ç½²éªŒè¯)
- âš ï¸ ç›‘æ§å‘Šè­¦é…ç½®å®Œæˆ (éœ€è¿ç»´é…ç½®)
- âš ï¸ å›æ»šæ–¹æ¡ˆéªŒè¯é€šè¿‡ (éœ€å®é™…æ¼”ç»ƒ)
- âœ… æ–‡æ¡£å®Œæ•´
- âš ï¸ ç”¨æˆ·åŸ¹è®­å®Œæˆ (éœ€å®é™…åŸ¹è®­)

---

## ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•

### æŸ¥çœ‹å½“å‰é…ç½®
```
/taker_window
```

### è®¾ç½®æ–°çš„æ—¶é—´çª—å£
```
/taker_window set 120  # è®¾ç½®ä¸º2å°æ—¶
/taker_window set 30   # è®¾ç½®ä¸º30åˆ†é’Ÿ
```

### æŸ¥çœ‹æ‰€æœ‰å¯ç”¨é€‰é¡¹
```
/taker_window list
```

### æŸ¥çœ‹è¯¦ç»†é…ç½®
```
/taker_window current
```

### æŸ¥çœ‹åƒå•ç›‘æ§çŠ¶æ€
```
/taker_status
```

---

## ğŸ“ å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|---------|------|
| 1.0.0 | 2025-11-10 | åˆå§‹å®æ–½ï¼šæ—¶é—´çª—å£å¯é…ç½®åŒ– | Claude Code |

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **OpenSpecææ¡ˆ**: [openspec/changes/update-taker-monitor-time-window/](../openspec/changes/update-taker-monitor-time-window/)
- **æŠ€æœ¯è§„æ ¼**: [openspec/changes/update-taker-monitor-time-window/specs/enhancement/spec.md](../openspec/changes/update-taker-monitor-time-window/specs/enhancement/spec.md)
- **è®¾è®¡æ–‡æ¡£**: [openspec/changes/update-taker-monitor-time-window/design.md](../openspec/changes/update-taker-monitor-time-window/design.md)
- **ä»»åŠ¡æ¸…å•**: [openspec/changes/update-taker-monitor-time-window/tasks.md](../openspec/changes/update-taker-monitor-time-window/tasks.md)

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é…ç½®ç”Ÿæ•ˆ**: ä¿®æ”¹é…ç½®åéœ€è¦é‡å¯æœºå™¨äººæœåŠ¡æ‰èƒ½ç”Ÿæ•ˆ
2. **çª—å£å¤§å°**: å¿…é¡»æ˜¯5çš„å€æ•°ï¼ˆå¦‚ï¼š5, 10, 15, 20...ï¼‰
3. **å†…å­˜ä½¿ç”¨**: æ›´å¤§çš„çª—å£ä¼šæ¶ˆè€—æ›´å¤šå†…å­˜ï¼Œå»ºè®®ä¸è¶…è¿‡4å°æ—¶
4. **æ€§èƒ½å½±å“**: çª—å£è¶Šå¤§ï¼Œæ‰¹å¤„ç†å’Œæ¸…ç†æ“ä½œè¶Šè€—æ—¶
5. **å‘åå…¼å®¹**: æ­¤å˜æ›´ä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼Œä½†çª—å£å¤§å°æ”¹å˜å¯èƒ½å½±å“å‘Šè­¦è§¦å‘æ—¶æœº

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

1. **å®é™…éƒ¨ç½²æµ‹è¯•**: åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯æ–°åŠŸèƒ½
2. **æ€§èƒ½ç›‘æ§**: ç›‘æ§å†…å­˜å’ŒCPUä½¿ç”¨æƒ…å†µ
3. **ç”¨æˆ·åŸ¹è®­**: å‘ç”¨æˆ·ä»‹ç»æ–°å‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•
4. **ç›‘æ§å‘Šè­¦**: é…ç½®ç›¸å…³ç›‘æ§å’Œå‘Šè­¦è§„åˆ™
5. **æ–‡æ¡£æ›´æ–°**: æ›´æ–°ç”¨æˆ·æ‰‹å†Œå’Œè¿ç»´æ–‡æ¡£

---

**å®æ–½çŠ¶æ€**: âœ… å®Œæˆ
**è´Ÿè´£äºº**: Claude Code
**æœ€åæ›´æ–°**: 2025-11-10
